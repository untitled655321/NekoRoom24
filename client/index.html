<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
</head>
<body style="background-color:black; color:white;">

<div id="gameDiv">
  <div id="gameScreen">
<canvas id="canvas" width="500" height="500" style="position:absolute;border: solid 1px black"></canvas>
</div>
<div id="playerUi" style="position:absolute; top:0;left:0px;">
  <button id="join_game_button" onclick="joinGame()" style="position:absolute; top:250px;left:250px;">Join Game</button>
  <button id="left_game_button" onclick="leftGame()" style=" display:none;">Left Room</button>
</div>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.dev.js"></script>


<script>
var join_game_button = document.getElementById("join_game_button");
var left_game_button = document.getElementById("left_game_button");
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
ctx.font = "30px";
var WIDTH = 500;
var HEIGHT = 500;
var socket = io();

var resizeCanvas = function(){
  WIDTH = window.innerWidth;
  HEIGHT = window.innerHeight;
  canvas.width = WIDTH;
  canvas.height = HEIGHT;
}
resizeCanvas();
window.addEventListener('resize', function(){
  resizeCanvas();
});

var joinGame = function(){
  socket.emit('findNewRoom',{gamemode:'casual',id:socket.id});
}
socket.on('joinRoomSuccess',function(data){
  join_game_button.style = "display:none";
  left_game_button.style = "display:block";
});
var leftGame = function(){
  socket.emit('leftRoom',socket.id);
}
socket.on('leftSuccess',function(data){
  if(data!== undefined){

    if(data.state){
  join_game_button.style = "display:inline-block";
  left_game_button.style = "display:none";
}
}
});

var Img = {};
Img.player = new Image();
Img.player.src = 'player.png';
Img.map = new Image();
Img.map.src = 'map.png';

  var Player = function(initPack){
    var self ={
      id: initPack.id,
      x: initPack.x,
      y: initPack.y,
      spdX: initPack.spdX,
      spdY: initPack.spdY,
      pressingUp: initPack.pressingRight,
      pressingLeft: initPack.pressingLeft,
      pressingUp: initPack.pressingUp,
      pressingDown: initPack.pressingDown,
      animation_counter:0

    };
    self.draw = function(){
      var x = self.x - Player.list[selfId].x + WIDTH/2;
var y  = self.y - Player.list[selfId].y + HEIGHT/2;

        var width = Img.player.width ;
        var height = Img.player.height/3;
        var grid_height = Img.player.height/9;
        var grid_width= Img.player.width/2;
        var start_x_animation = 0;
        var start_y_animation = 0;
        if(self.pressingRight||self.pressingLeft||self.pressingUp||self.pressingDown){
          if(self.pressingRight){
            if(self.pressingUp){
              start_y_animation = grid_height *8;

            }
            else if(self.pressingDown)
            {
              start_y_animation = grid_height *6;

            }
            else{
              start_y_animation = grid_height*2;
            }

          }
          else if(self.pressingLeft){
            if(self.pressingUp){
              start_y_animation = grid_height *7;

            }
            else if(self.pressingDown)
            {
              start_y_animation = grid_height *5;

            }
            else{
              start_y_animation = grid_height;
            }
          }
          else if(self.pressingUp){
            start_y_animation = grid_height*3;

          }
          else if(self.pressingDown)
          {
            start_y_animation = grid_height*4;

          }


          start_x_animation = grid_width*(self.animation_counter%2);
        }
            //console.log(self.animation_counter%2);
            ctx.drawImage(Img.player,start_x_animation,start_y_animation,grid_width,grid_height,x-width/8,y-height/8,width/4,height/4);
            //ctx.fillText("P",self.x,self.y);
    }
    Player.list[self.id] = self;
    return self;
  }
  Player.list = {};

//initpialize object in world
  socket.on("initPack", function(data){

    if(data!== null){
      if(data[Object.keys(data)[0]] !== undefined){
        //console.log(data[Object.keys(data)[0]][0].players);
        var players_array = data[Object.keys(data)[0]][0].players;
        for(var i in players_array)
        {
          new Player(players_array[i]);
        }

      }
      if(data.initBullet !== undefined){


      }
    }

  });

//update objects in world
    socket.on("updatePack", function(data){
      if(data !== null){
        //console.log(data);
        if(data[Object.keys(data)[1]] !== undefined){
          var Object_with_players = data[Object.keys(data)[1]];
          var size = Object.size(Object_with_players);
        //console.log(size);
          //console.log(player_array);
          for(var i=0;i<size;i++){
          //console.log(i);

          var player_array = Object_with_players[Object.keys(Object_with_players)[i]];
            //console.log(player_array.id);
            //console.log(player_array.id)
           var player = player_array;
           Player.list[player.id].x = player.x;
           Player.list[player.id].y = player.y;
           Player.list[player.id].pressingRight = player.pressingRight;
           Player.list[player.id].pressingLeft = player.pressingLeft;
           Player.list[player.id].pressingUp = player.pressingUp;
           Player.list[player.id].pressingDown = player.pressingDown;
        }
      }
      }
    });

//remove objects from world
  socket.on("removePack", function(data){
    //console.log(data);
    if(data !== undefined){
      // data[Object.keys(data)[something]] something- for index notation Of objest inside object
      if(data[Object.keys(data)[0]] !== undefined){
        var Object_with_players = data[Object.keys(data)[0]];
        var size = Object.size(Object_with_players);
      //console.log(size);
        //console.log(player_array);
        for(var i=0;i<size;i++){
        //console.log(i);

        var player_array = Object_with_players[Object.keys(Object_with_players)[i]];
          //console.log(player_array.id);
          //console.log(player_array.id)
         var player = player_array;
         console.log(player.players.id);
        delete Player.list[player.players.id];

      }
    }
    }
  });

var selfId = "";
socket.on('selfId',function(data){
  selfId= data;
});
  setInterval(function(){

    ctx.clearRect(0,0,WIDTH,HEIGHT);
    drawMap();
    for(var i in Player.list){
      var player  = Player.list[i];
      player.draw();
    }

  },40);
  setInterval(function(){
  for(var i in Player.list){
    Player.list[i].animation_counter +=1;
  }
},100);

var drawMap = function(){

  var player = Player.list[selfId];
  if(player!==undefined){
    var x = WIDTH/2 - player.x;
    var y  = HEIGHT/2 - player.y;
  ctx.drawImage(Img.map,x-67,y-50,645,645);
}
}

document.onkeydown  = function(event){
  if(event.keyCode == 68)
    socket.emit('keyPress', {inputId: 'right', state:true});
  else if(event.keyCode == 83)
    socket.emit('keyPress', {inputId: 'down', state:true});
  else if(event.keyCode == 65)
    socket.emit('keyPress', {inputId: 'left', state:true});
  else if(event.keyCode == 87)
    socket.emit('keyPress', {inputId: 'up', state:true});

}
document.onkeyup  = function(event){
  if(event.keyCode == 68)
    socket.emit('keyPress', {inputId: 'right', state:false});
  else if(event.keyCode == 83)
    socket.emit('keyPress', {inputId: 'down', state:false});
  else if(event.keyCode == 65)
    socket.emit('keyPress', {inputId: 'left', state:false});
  else if(event.keyCode == 87)
    socket.emit('keyPress', {inputId: 'up', state:false});

}


Object.size = function(obj) {
    var size = 0, key;
    for (key in obj) {
        if (obj.hasOwnProperty(key)) size++;
    }
    return size;
};

</script>

</body>
